<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>购物车 - 结算</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Arial', sans-serif;
        }

        body {
            background-color: #f5f7fa;
            color: #333;
            padding: 20px;
            max-width: 1200px;
            margin: 0 auto;
        }

        .page-title {
            margin: 30px 0;
            color: #333;
            padding-bottom: 10px;
            border-bottom: 2px solid #4285f4;
        }

        .cart-container {
            background-color: white;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
            overflow: hidden;
        }

        .cart-header {
            display: grid;
            grid-template-columns: 4fr 1fr 1fr 1fr;
            padding: 15px 20px;
            background-color: #f8f9fa;
            font-weight: bold;
            border-bottom: 1px solid #eee;
        }

        .cart-item {
            display: grid;
            grid-template-columns: 4fr 1fr 1fr 1fr;
            padding: 15px 20px;
            align-items: center;
            border-bottom: 1px solid #eee;
        }

        .product-details {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .product-image {
            width: 80px;
            height: 80px;
            object-fit: cover;
            border-radius: 4px;
        }

        .product-name {
            font-weight: 500;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-btn {
            width: 30px;
            height: 30px;
            border: 1px solid #ddd;
            background-color: #f1f1f1;
            border-radius: 4px;
            cursor: pointer;
        }

        .quantity-input {
            width: 40px;
            height: 30px;
            text-align: center;
            border: 1px solid #ddd;
            border-radius: 4px;
        }

        .item-price {
            color: #e53935;
            font-weight: 500;
        }

        .item-total {
            color: #e53935;
            font-weight: bold;
        }

        .remove-btn {
            color: #dc3545;
            background: none;
            border: none;
            cursor: pointer;
            padding: 5px;
        }

        .remove-btn:hover {
            text-decoration: underline;
        }

        .cart-summary {
            padding: 20px;
            text-align: right;
        }

        .total-amount {
            font-size: 18px;
            margin-bottom: 20px;
        }

        .total-amount span {
            color: #e53935;
            font-size: 22px;
            font-weight: bold;
        }

        .checkout-btn {
            padding: 12px 30px;
            background-color: #4285f4;
            color: white;
            border: none;
            border-radius: 5px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: background-color 0.3s;
        }

        .checkout-btn:hover {
            background-color: #3367d6;
        }

        .empty-cart {
            padding: 60px 20px;
            text-align: center;
            color: #666;
        }

        .empty-cart a {
            color: #4285f4;
            text-decoration: none;
        }

        .empty-cart a:hover {
            text-decoration: underline;
        }
        /* 返回主页按钮样式 */
        .back-home-container {
            margin: 20px 0;
            text-align: right;
        }

        .back-home-btn {
            display: inline-flex;
            align-items: center;
            gap: 8px;
            padding: 8px 16px;
            background-color: #f0f2f5;
            color: #333;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 14px;
            transition: all 0.2s;
            text-decoration: none;
        }

        .back-home-btn:hover {
            background-color: #e5e7eb;
            color: #000;
        }

        .back-home-btn i {
            font-size: 16px;
        }
        
        /* 用户欢迎区域样式 */
        .user-welcome {
            background-color: #e3f2fd;
            padding: 10px 20px;
            border-radius: 4px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
    </style>
</head>
<body>
<h1 class="page-title">购物车结算</h1>

<!-- 用户欢迎区域 -->
<div class="user-welcome">
    <div>你好，<span id="welcomeUsername">用户</span></div>
    <a href="/products" class="back-home-btn">
        <i class="fa fa-home"></i> 返回主页
    </a>
</div>

<div class="cart-container">
    <div class="cart-header">
        <div>商品信息</div>
        <div>单价</div>
        <div>数量</div>
        <div>小计</div>
    </div>

    <div id="cartItems">
        <!-- 购物车商品将通过JavaScript动态生成 -->
    </div>
    
    <div class="cart-summary">
        <div class="total-amount">
            总计: <span id="totalPrice">¥0.00</span>
        </div>
        <button class="checkout-btn" id="checkoutBtn">结算</button>
    </div>
</div>

<script>
    // 设置欢迎词中的用户名
    function setWelcomeUsername() {
        // 从sessionStorage中获取用户名（如果之前已保存）
        const username = sessionStorage.getItem('username');
        if (username) {
            document.getElementById('welcomeUsername').textContent = username;
        } else {
            // 尝试从URL参数获取用户名
            const urlParams = new URLSearchParams(window.location.search);
            const usernameParam = urlParams.get('username');
            if (usernameParam) {
                document.getElementById('welcomeUsername').textContent = usernameParam;
                // 保存到sessionStorage供后续使用
                sessionStorage.setItem('username', usernameParam);
            }
        }
    }

     let username="";
    // 解析URL参数
    function getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const paramPairs = queryString.split('&');

        for (const pair of paramPairs) {
            const [key, value] = pair.split('=');
            if (key) {
                params[key] = decodeURIComponent(value || '');
            }
        }
        console.log(params);
        username=params.username;
        return params;
    }

    // 页面加载时检查是否有需要添加的商品
    async function checkAndAddProduct() {
        const params = getUrlParams();
        console.log("1"+params);
        if (params.productId) {
            try {
                // 添加商品到购物车
                const response = await fetch('/CartServlet', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `action=add&productId=${params.productId}&quantity=1`
                });
                
                // 检查响应的内容类型
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await response.json();
                    if (!data.success) {
                        if (data.needLogin) {
                            // 用户未登录，跳转到登录页
                            window.location.href = `login.html?redirect=cart.html&productId=${params.productId}`;
                            return;
                        } else {
                            alert('添加商品到购物车失败: ' + data.message);
                        }
                    }
                } else {
                    // 如果不是JSON响应，可能是重定向到登录页
                    window.location.href = `login.html?redirect=cart.html&productId=${params.productId}`;
                }

                // 移除URL中的productId参数，避免刷新页面重复添加
                // window.history.replaceState({}, document.title, window.location.pathname);
            } catch (error) {
                console.error('添加商品到购物车失败:', error);
                // 出现错误时跳转到登录页
                const params = getUrlParams();
                window.location.href = `login.html?redirect=cart.html&productId=${params.productId || ''}`;
            }
        }
    }

    // 加载购物车数据
    async function loadCartData() {
        try {
            const response = await fetch('/CartServlet', {
                method: 'GET',
                credentials: 'include',
                headers: {
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });
            
            // 检查响应的内容类型
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await response.json();
                console.log(data)
                if (!data.success) {
                    if (data.needLogin) {
                        // 用户未登录，跳转到登录页
                        const urlParams = new URLSearchParams(window.location.search);
                        const productId = urlParams.get('productId');
                        let redirectUrl = 'login.html?redirect=cart.html';
                        if (productId) {
                            redirectUrl += '&productId=' + productId;
                        }
                        window.location.href = redirectUrl;
                    } else {
                        alert('加载购物车失败: ' + data.message);
                    }
                    return;
                }

                renderCart(data.cartItems, data.totalPrice);
            } else {
                // 如果不是JSON响应，可能是重定向到登录页
                window.location.href = 'login.html?redirect=cart.html';
            }
        } catch (error) {
            console.error('加载购物车数据失败:', error);
            alert('加载购物车时发生错误');
        }
    }

    // 渲染购物车
    function renderCart(items, totalPrice) {
        const cartItemsContainer = document.getElementById('cartItems');
        const totalPriceElement = document.getElementById('totalPrice');

        if (items.length === 0) {
            cartItemsContainer.innerHTML = `
                    <div class="empty-cart">
                        <p>您的购物车是空的</p>
                        <a href="../index.jsp">继续购物</a>
                    </div>
                `;
            totalPriceElement.textContent = '¥0.00';
            return;
        }

        // 清空现有内容
        cartItemsContainer.innerHTML = '';

        // 渲染每个商品
        items.forEach(item => {
            const cartItem = document.createElement('div');
            cartItem.className = 'cart-item';
            cartItem.innerHTML = `
                    <div class="product-details">
                        <img src="${item.image}" alt="${item.name}" class="product-image">
                        <div>
                            <div class="product-name">${item.name}</div>
                            <button class="remove-btn" onclick="removeFromCart(${item.productId})">删除</button>
                        </div>
                    </div>
                    <div class="item-price">¥${item.price.toFixed(2)}</div>
                    <div class="quantity-control">
                        <button class="quantity-btn" onclick="updateQuantity(${item.productId}, -1)">-</button>
                        <input type="number" class="quantity-input" value="${item.quantity}" min="1"
                               onchange="setQuantity(${item.productId}, this.value)">
                        <button class="quantity-btn" onclick="updateQuantity(${item.productId}, 1)">+</button>
                    </div>
                    <div class="item-total">¥${(item.price * item.quantity).toFixed(2)}</div>
                `;
            cartItemsContainer.appendChild(cartItem);
        });

        // 更新总价
        totalPriceElement.textContent = `¥${totalPrice.toFixed(2)}`;
    }

    // 从购物车移除商品
    async function removeFromCart(productId) {
        try {
            const response = await fetch('/CartServlet', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `action=remove&productId=${productId}`
            });

            // 检查响应的内容类型
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await response.json();
                if (data.success) {
                    renderCart(data.cartItems, data.totalPrice);
                } else {
                    alert('操作失败: ' + data.message);
                }
            } else {
                // 如果不是JSON响应，可能是重定向到登录页
                window.location.href = 'login.html?redirect=cart.html';
            }
        } catch (error) {
            console.error('移除商品失败:', error);
        }
    }

    // 更新商品数量
    async function updateQuantity(productId, change) {
        try {
            // 找到当前数量
            const inputElement = document.querySelector(`input[onchange="setQuantity(${productId}, this.value)"]`);
            if (inputElement) {
                let currentQuantity = parseInt(inputElement.value);
                let newQuantity = currentQuantity + change;

                if (newQuantity < 1) newQuantity = 1;

                const response = await fetch('/CartServlet', {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                        'X-Requested-With': 'XMLHttpRequest'
                    },
                    body: `action=update&productId=${productId}&quantity=${newQuantity}`
                });

                // 检查响应的内容类型
                const contentType = response.headers.get("content-type");
                if (contentType && contentType.indexOf("application/json") !== -1) {
                    const data = await response.json();
                    if (data.success) {
                        renderCart(data.cartItems, data.totalPrice);
                    } else {
                        alert('操作失败: ' + data.message);
                    }
                } else {
                    // 如果不是JSON响应，可能是重定向到登录页
                    window.location.href = 'login.html?redirect=cart.html';
                }
            }
        } catch (error) {
            console.error('更新数量失败:', error);
        }
    }

    // 直接设置商品数量
    async function setQuantity(productId, value) {
        let quantity = parseInt(value);
        if (isNaN(quantity) || quantity < 1) quantity = 1;

        try {
            const response = await fetch('/CartServlet', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'X-Requested-With': 'XMLHttpRequest'
                },
                body: `action=update&productId=${productId}&quantity=${quantity}`
            });

            // 检查响应的内容类型
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.indexOf("application/json") !== -1) {
                const data = await response.json();
                if (data.success) {
                    renderCart(data.cartItems, data.totalPrice);
                } else {
                    alert('操作失败: ' + data.message);
                }
            } else {
                // 如果不是JSON响应，可能是重定向到登录页
                window.location.href = 'login.html?redirect=cart.html';
            }
        } catch (error) {
            console.error('设置数量失败:', error);
        }
    }

    // 结算
    document.getElementById('checkoutBtn').addEventListener('click', function () {
        // 检查购物车是否为空
        const totalPrice = document.getElementById('totalPrice').textContent;
        if (totalPrice === '¥0.00') {
            alert('购物车为空，无法结算');
            return;
        }

        alert('结算成功！感谢您的购买。');
        // 实际应用中，这里会跳转到支付页面
    });

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', async () => {
        // 设置欢迎用户名
        setWelcomeUsername();
        // 检查是否有需要添加的商品
        await checkAndAddProduct();
        // 加载购物车数据
        await loadCartData();
    });
</script>
</body>
</html>