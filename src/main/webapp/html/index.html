<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>首页 - 商品列表</title>
<link href="../css/index.css" rel="stylesheet" />
</head>
<body>
<!-- 欢迎区域 -->
<div class="welcome-section">
    <h3 class="welcome-title">
        你好，<span id="welcomeUsername"></span>，欢迎来到我们的商店！
    </h3>
</div>

<!-- 商品列表区域 -->
<div class="products-section">
    <h2 class="section-title">热门商品</h2>
    <div class="product-list" id="productList">
        <!-- 商品将通过JavaScript动态生成 -->
    </div>
</div>

<script>
    // 商品数据
    const products = [
        { id: 1, name: "智能手表 Pro 多功能运动监测", price: 1299, image: "https://picsum.photos/id/96/300/300" },
        { id: 2, name: "无线蓝牙耳机 主动降噪", price: 899, image: "https://picsum.photos/id/26/300/300" },
        { id: 3, name: "便携式笔记本电脑支架", price: 129, image: "https://picsum.photos/id/119/300/300" },
        { id: 4, name: "机械键盘 青轴 背光", price: 349, image: "https://picsum.photos/id/160/300/300" }
    ];

    // 解析URL参数
    function getUrlParams() {
        const params = {};
        const queryString = window.location.search.substring(1);
        const paramPairs = queryString.split('&');

        for (const pair of paramPairs) {
            const [key, value] = pair.split('=');
            if (key) {
                params[key] = decodeURIComponent(value || '');
            }
        }
        return params;
    }

    // 显示用户名
    function showUsername() {
        const params = getUrlParams();
        const username = params.username || '游客';
        document.getElementById('welcomeUsername').textContent = username;
    }

    // 生成商品列表
    function renderProducts() {
        const productList = document.getElementById('productList');

        products.forEach(product => {
            const productCard = document.createElement('div');
            productCard.className = 'product-card';
            productCard.innerHTML = `
                    <img src="${product.image}" alt="${product.name}" class="product-image">
                    <div class="product-info">
                        <h3 class="product-name">${product.name}</h3>
                        <p class="product-price">¥${product.price.toFixed(2)}</p>
                        <button class="buy-button" onclick="addToCart(${product.id})">
                            加入购物车
                        </button>
                    </div>
                `;
            productList.appendChild(productCard);
        });
    }

    // 检查用户登录状态
    async function checkLoginStatus() {
        try {
            const response = await fetch('/CartServlet', {
                method: 'GET',
                credentials: 'include'
            });
            const data = await response.json();
            return data.success; // 已登录返回true，未登录返回false
        } catch (error) {
            console.error('检查登录状态失败:', error);
            return false;
        }
    }

    // 添加到购物车
    async function addToCart(productId) {
        // 检查登录状态
        const isLoggedIn = await checkLoginStatus();

        if (!isLoggedIn) {
            // 未登录，跳转到登录页，携带目标页面和商品ID
            window.location.href = `login.html?redirect=cart.html&productId=${productId}`;
            return;
        }

        // 已登录，直接添加到购物车
        try {
            const response = await fetch('/CartServlet', {
                method: 'POST',
                credentials: 'include',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded'
                },
                body: `action=add&productId=${productId}&quantity=1`
            });

            const data = await response.json();
            if (data.success) {
                // alert('商品已添加到购物车！');
                // 跳转到购物车页面
                window.location.href = 'cart.html';
            } else {
                alert('添加失败: ' + data.message);
            }
        } catch (error) {
            console.error('添加到购物车失败:', error);
            alert('添加到购物车时发生错误');
        }
    }

    // 页面加载完成后执行
    document.addEventListener('DOMContentLoaded', () => {
        showUsername();
        renderProducts();
    });
</script>
</body>
</html>
